<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle</title>
    <link rel="stylesheet" href="/_css/style.css">
</head>

<body>
    <div id="botoes" style="display: grid;gap: 1em;grid-template-columns: repeat(4, 1fr);grid-auto-rows: 1em;">
        <p id="teste"></p>
    </div>
    <script src="/_script/botoes.js"></script>
    <script>
        let host = window.location.hostname;
        //serve para permitir usuario ficar preicionando botao e ele enviar o codigo multiplas vezes em quanto precionado
        let pressing = false

        function send(botao) {
            console.log(botao);
            if (botao.function === "conectarbluetooth") {
                requestDevices()
            }
            /* var request = new XMLHttpRequest();
            if (botao.path) {
                request.open('GET', `http://${host}/${botao.path}`);
                request.send();
            } else {
                request.open('POST', 'http://' + host + '/send', true);
                request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
                request.send(`code=${botao.value}`);
            }
            navigator.vibrate(200);
            setTimeout(() => {
                if (pressing) send(botao);
            }, 1000); */
        };
        function start(botao) {
            pressing = true;
            send(botao)
        };
        function end(botao) {
            pressing = false;
        };
        const element = document.getElementById("botoes");
        botoes.forEach(b => {
            const button = document.createElement("button");
            button.innerText = b.name;
            button.onmousedown = start.bind(this, b);
            button.onmouseup = end.bind(this, b);
            button.ontouchstart = start.bind(this, b);
            button.ontouchend = end.bind(this, b);
            button.setAttribute("class", b.class);
            element.appendChild(button)
        });
    </script>
    <script>
        var characteristic
        var device
        async function requestDevices() {
            console.log("entrou no request")
            if (!navigator.bluetooth) return alert("Nao possue Bluetooth no Navegador");

            if (!device) {
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['12634d89-d598-4874-8e86-7d042ee07ba7', '4116f8d2-9f66-4f58-a53d-fc7440e7c14e']
                });
                device.ongattserverdisconnected = (e) => {
                    alert(`Disconectou: ${e.type}`)
                    connect()
                }

            }
            if (!device) return alert("Erro ao conectar...");

            alert(`Name: ${device.name}`);

            await connect()
            alert(characteristic.writeValue)
            alert(characteristic.writeValueWithoutResponse)

            characteristic.writeValue(new TextEncoder().encode('ON'))
                .then(v => alert(`then: ${v}`))
                .catch(r => alert(`WV catch: ${r}`));
            characteristic.writeValueWithoutResponse(new TextEncoder().encode('agora esta funcionando'))
                .then(v => alert(`then: ${v}`))
                .catch(r => alert(`WVWR catch: ${r}`));
        }
        async function connect() {
            alert("conectando...")
            const server = await device.gatt.connect()
            if (!server) return alert(server)
            const service = await server.getPrimaryService('12634d89-d598-4874-8e86-7d042ee07ba7');
            if (!service) return alert(service)
            alert("pegando characteristic")
            characteristic = await service.getCharacteristic('4116f8d2-9f66-4f58-a53d-fc7440e7c14e');
            alert("conectado")
            characteristic.startNotifications()
            characteristic.addEventListener('characteristicvaluechanged', (event) => {
                const value = event.target.value;
                console.log('Received ' + value);
                document.getElementById("teste").innerText = value
                // TODO: Parse Heart Rate Measurement value.
                // See https://github.com/WebBluetoothCG/demos/blob/gh-pages/heart-rate-sensor/heartRateSensor.js
            });
        }
        async function writeValue() {
            const text = document.getElementById("msg").value
            characteristic.writeValue(new TextEncoder().encode(text))
                .then(v => alert(`then: ${v}`))
                .catch(r => alert(`catch: ${r}`));
        }
    </script>
</body>

</html>